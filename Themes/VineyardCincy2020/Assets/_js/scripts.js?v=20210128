$(document).ready(function () {
  /*** Tagline Marquee Looper */
  let marquee = document.querySelectorAll(".smallthingsbanner");
  marquee.forEach((outer) => {
    let content = outer.querySelector("p");
    repeatContent(content, outer.offsetWidth);
    let el = outer.querySelector(".block-content > div > p");
    el.innerHTML = el.innerHTML + el.innerHTML;

    function repeatContent(el, till) {
      let html = el.innerHTML;
      let counter = 0; // prevents infinite loop

      while (el.offsetWidth < till && counter < 100) {
        el.innerHTML += html;
        counter += 1;
      }
    }
  });

  $.preloadImages = function () {
    for (var i = 0; i < arguments.length; i++) {
      $("<img />").attr("src", arguments[i]);
    }
  };
  $("#c-circle-nav").each(function () {
    $(this).css("top", $("#emergency-notification").outerHeight() + 14);
  });
  $("body.noheader").css("padding-top", $("#header").outerHeight());
  $.preloadImages(
    "/Themes/VineyardCincy2020/Assets/_img/vineyard_cincy_logo-color.svg"
  ); //preload for hover

  $("<span class='line'></span>")
    .appendTo("#announcement-rotator .container")
    .hide()
    .delay(2000)
    .slideDown();

  $(".accordion").accordion({
    heightStyle: "content",
    active: false,
    collapsible: true,
    create: function (event, ui) {
      $("<div class='divider' />").insertAfter(
        ".accordion .ui-accordion-content"
      );
    },
    activate: function (event, ui) {
      //console.log(event);
      //console.log(ui);

      var $newHeader = ui.newHeader;

      //console.log($newHeader.length);

      if ($newHeader.length) {
        $("html,body").animate(
          {
            scrollTop: $newHeader.offset().top - 97,
          },
          500
        );
        return false;
      }
    },
  });

  $("<div class='divider' />").appendTo("blockquote");

  $("[data-toggle=popover]").on("click", function (e) {
    e.preventDefault();
  });
  $("[data-toggle=popover]").popover({
    html: true,
    content: function () {
      return $("#popover-content").html();
    },
  });

  $(".menu-trigger").on("click", function (e) {
    e.preventDefault();
    $("body").addClass("nooverflow");
    $(".primary-navigation").slideDown();
    $("header#header").css("z-index", "1001");
  });
  $(".search-trigger").on("click", function (e) {
    e.preventDefault();
    $("body").addClass("noscroll");
    $(".search-box").slideDown();
    $("#searchQuery").focus();
  });

  // initiate search if entered
  $("#search-banner .btn").on('click', function (e) {
    var value = $("#searchQuery").val();
    e.preventDefault();
    submitSearchSite(value);
  });

  // initiate search if entered
  $("#searchQuery").on('keydown', function (e) {
    var value = $(this).val();
    if (e.keyCode == 13) {
      e.preventDefault();
      submitSearchSite(value);
    }
  });
  function submitSearchSite(val) {
    window.location = "/search?siteName=Vineyard+Cincinnati+Church&q="+val;
   // window.location = "/search?q="+val;

  }

  $(".menu-closer").on("click", function (e) {
    e.preventDefault();
    $("body").removeClass("nooverflow");
    $(".primary-navigation").slideUp();
    $("header#header").css("z-index", "999");
  });
  $(".search-close").on("click", function (e) {
    e.preventDefault();
    $("body").removeClass("noscroll");
    $(".search-box").slideUp();
    $("#searchQuery").blur();
  });
  $(".staffPhoto").each(function () {
    //window.console.log($(this));
    $(this).hover(
      function () {
        var contactInfo = $(this).find(".contactInfo");
        contactInfo.fadeIn();
      },
      function () {
        var contactInfo = $(this).find(".contactInfo");
        contactInfo.fadeOut();
      }
    );
  });
  $(".events-expander").on("click", "a", function (e) {
    e.preventDefault();
    $(this).parent().hide();
    $(".additional-events .hidden-events").slideDown();
    $(".events-collapsor").show();
  });
  $(".events-collapsor").on("click", "a", function (e) {
    e.preventDefault();
    $(this).parent().hide();
    $(".additional-events .hidden-events").slideUp();
    $(".events-expander").show();
  });
  $(".campusMinistryLinks").slick({
    dots: true,
    infinite: true,
    speed: 300,
    slidesToShow: 5,
    slidesToScroll: 5,
    responsive: [
      {
        breakpoint: 1024,
        settings: {
          slidesToShow: 3,
          slidesToScroll: 3,
          infinite: true,
          dots: true,
        },
      },
      {
        breakpoint: 600,
        settings: {
          slidesToShow: 2,
          slidesToScroll: 2,
        },
      },
      {
        breakpoint: 480,
        settings: {
          slidesToShow: 2,
          slidesToScroll: 2,
        },
      },
      // You can unslick at a given breakpoint now by adding:
      // settings: "unslick"
      // instead of a settings object
    ],
  });
  if (window.innerWidth >= 992) {
    $(".sermondetail").each(function () {
      var parentContainer = $(this).closest(".container");
      $(parentContainer).after($(this)); //append .sermondetail divs outside grid
    });
  }
  $("a.closer").click(function (e) {
    e.preventDefault();
    $(".sermondetail").hide();
    $(".sermon").removeClass("open");
    $(".sermon").removeClass("closed");
  });

  $("a.showdetail").click(function (e) {
    e.preventDefault();
    var currentsermon = $(this).closest("div.sermon");
    var thisseriesid = $(this).data("openid");

    if (currentsermon.hasClass("open")) {
      //close current sermon, full opacity
      //console.log("was open");
      $(".sermondetail").hide();
      $(".sermon").removeClass("open");
      $(".sermon").removeClass("closed");
    } else {
      //open current sermon, dim all others
      //console.log("was closed");
      $(".sermondetail").hide();
      $(".sermon").removeClass("closed");
      $(".sermon").not(currentsermon).removeClass("open").addClass("closed");
      $("#" + thisseriesid).slideDown();
      currentsermon.addClass("open");

      var containerPos =
        $("#" + thisseriesid).offset().top - $(".navbar").height();
      $("html, body").animate({ scrollTop: containerPos }, 600);
    }
  });

  // Infinite Scroll with Isotope
  /* init Isotope
	var $grid = $('#postlist').isotope({
	  // Isotope options...
	  percentPosition: true,
	  itemSelector: '.block',
		layoutMode: 'packery',
	  packery: {
	    // use element for option
	    columnWidth: '.block:nth-child(2)'
	  }
	});
	*/

  var $grid = $("#postlist").isotope({
    layoutMode: "packery",
    itemSelector: ".block",
    //transitionDuration: '1s',
    //debug: true,
    stagger: 30,
  });

  // get Isotope instance
  var iso = $grid.data("isotope");

  // init Infinite Scroll
  $grid.infiniteScroll({
    // Infinite Scroll options...
    path: "#next",
    append: ".block",
    status: ".page-load-status",
    hideNav: "#pagination",
    outlayer: iso,
    scrollThreshold: 100,
    prefill: true,
    //debug: true,
    history: false,
  });

  /*
  // append items on load
  $grid.on( 'load.infiniteScroll', function( event, response, path ) {
    var $items = $( response ).find('.block');
    $grid.isotope( 'insert', $items );
    // append items after images loaded
    $items.imagesLoaded( function() {
      //$grid.append( $items );
      //$grid.isotope( 'insert', $items );
      //$items.addClass('iso-loaded');
    });
  });
*/

  $(".filter-button-group").on("click", "a", function (e) {
    e.preventDefault();
    $(".filter-button-group li").removeClass("active");
    $(this).parent("li").addClass("active");
    var filterValue = $(this).attr("data-filter");
    $grid.isotope({ filter: filterValue });
  });

  /***** SERVE ACCORDIONS ******/
  $(".opp .show-details").on("click", function (e) {
    e.preventDefault();
    var details = $(this).closest(".oppsummary").siblings(".oppdetails");
    $(".opp .oppdetails").hide();
    if ($(this).hasClass("active")) {
      $(".opp .show-details").removeClass("active");
      $(this).blur();
    } else {
      $(".opp .show-details").removeClass("active");
      $(this).addClass("active");
      $(details).slideDown();
    }
  });
});
